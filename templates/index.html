<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- Link to external stylesheet with version for cache busting -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=13">
  <title>カード診断</title>
  <style>
    /* Accordion styles for filter sections */
    .acc { border: 1px solid #ddd; border-radius: 6px; margin: 10px 0; background: #fff; overflow: hidden; /* Prevents content overflow */}
    .acc[open] { box-shadow: 0 1px 3px rgba(0,0,0,0.1); } /* Add shadow when open */
    .acc-summary {
      list-style: none; /* Remove default marker */
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 15px; /* Adjust padding */
      background-color: #f8f9fa; /* Light background for summary */
      border-bottom: 1px solid #eee; /* Separator line */
    }
    /* Hide default markers for details/summary */
    .acc-summary::-webkit-details-marker { display: none; }
    .acc-summary::marker { display: none; }
    .acc-title { font-weight: 600; flex-grow: 1; color: #333; }
    .acc-meta { font-size: .9rem; color: #555; white-space: nowrap; }
    .chevron {
        transition: transform .2s ease;
        user-select: none; /* Prevent text selection */
        font-size: 1.2em; /* Make arrow slightly larger */
        color: #777;
        width: 20px; /* Ensure space for the icon */
        text-align: center;
    }
    /* Rotate chevron when accordion is open */
    .acc[open] > .acc-summary .chevron { transform: rotate(180deg); }
    .acc-content { padding: 10px 15px 15px; border-top: none; /* Remove top border as summary has bottom border */ background-color: #fff; }
  </style>
</head>
<body>
  <div class="container">
    <h1>クレジットカード診断</h1>
    {% if results_html %}
      <!-- Section to display results -->
      <div id="results">
        {{ results_html|safe }} {# Render HTML generated by display_cards #}
      </div>
      <!-- Back button form -->
      <form action="/" method="get" class="back-button" style="text-align: center; margin-top: 25px;">
        <button type="submit">診断条件を再入力する</button>
      </form>
    {% else %}
      <!-- Input form section -->
      <p>あなたにぴったりのクレジットカードを見つけましょう！</p>
      <form action="/diagnose" method="post">

        <!-- Monthly Spending Input (Optional) -->
        <label for="amount">月の利用金額（円）</label>
        <input type="number" id="amount" name="amount" min="0" placeholder="（任意）例: 50000">

        <!-- Minimum Cashback Rate Selection -->
        <label for="cashback">最低還元率（%）</label>
        <select id="cashback" name="cashback">
          <option value="0">指定なし (0%以上)</option>
          <option value="0.5">0.5%以上</option>
          <option value="1.0">1.0%以上</option>
          <option value="1.2">1.2%以上</option>
          <option value="1.5">1.5%以上</option>
        </select>

        <!-- Keyword Search Input -->
        <label for="keyword">キーワード検索</label>
        <input type="text" id="keyword" name="keyword" placeholder="カード名、発行会社名で検索 (例: 楽天)">

        <!-- Checkbox Filters in Accordions -->
        {% for key, group in groups.items() %}
          <details class="acc" data-key="{{ key }}">
            <summary class="acc-summary">
              <span class="acc-title">{{ group["title"] }}</span>
              <span class="acc-meta"><span class="sel-count" aria-live="polite">0</span> 件選択</span>
              <span class="chevron" aria-hidden="true">▼</span>
            </summary>
            <div class="acc-content">
              {% for item in group["items"] %}
                <label class="checkbox-block">
                  <input type="checkbox" name="{{ key }}" value="{{ item }}">
                  <span>{{ item }}</span> {# Wrap text in span for potential future styling #}
                </label>
              {% endfor %}
            </div>
          </details>
        {% endfor %}

        <!-- Submit Button -->
        <button type="submit">診断する</button>
      </form>
    {% endif %}
  </div>

  <!-- JavaScript for Accordion State Management -->
  <script>
    (function () {
      const ACC_STATE_KEY = "cc_filter_acc_open"; // Key for localStorage

      // Function to update the selected count display for each accordion
      function updateCounts() {
        document.querySelectorAll(".acc").forEach(acc => {
          const key = acc.getAttribute("data-key");
          const countEl = acc.querySelector(".sel-count");
          // Ensure elements exist before proceeding
          if (key && countEl) {
            const checkedCount = acc.querySelectorAll(`input[name="${key}"]:checked`).length;
            countEl.textContent = String(checkedCount); // Update the text content
          }
        });
      }

      // Function to restore the open/closed state of accordions from localStorage
      function restoreOpenState() {
        try {
          const rawState = localStorage.getItem(ACC_STATE_KEY);
          if (!rawState) return; // No saved state
          const state = JSON.parse(rawState);
          // Check if the parsed state is a valid object
          if (typeof state !== 'object' || state === null) return;

          document.querySelectorAll(".acc").forEach(acc => {
            const key = acc.getAttribute("data-key");
            // Check if the key exists in the saved state
            if (key && state.hasOwnProperty(key)) {
               if (state[key]) {
                   acc.setAttribute("open", ""); // Set to open if true in state
               } else {
                   acc.removeAttribute("open"); // Ensure closed if false in state
               }
            }
          });
        } catch (e) {
          console.error("Failed to restore accordion state:", e);
          localStorage.removeItem(ACC_STATE_KEY); // Clear potentially corrupted state
        }
      }

      // Function to save the current open/closed state of accordions to localStorage
      function saveOpenState() {
        const state = {};
        document.querySelectorAll(".acc").forEach(acc => {
          const key = acc.getAttribute("data-key");
          if (key) {
             // Store boolean indicating if 'open' attribute is present
             state[key] = acc.hasAttribute("open");
          }
        });
        try {
            localStorage.setItem(ACC_STATE_KEY, JSON.stringify(state));
        } catch (e) {
            // Handle potential storage errors (e.g., quota exceeded)
            console.error("Failed to save accordion state:", e);
        }
      }

      // Add event listener for changes to checkboxes within the form
      document.addEventListener("change", (e) => {
        // Only trigger update if the changed element is a checkbox
        if (e.target && e.target.matches('input[type="checkbox"]')) {
          updateCounts();
        }
      });

      // Add event listener for the 'toggle' event on details elements (accordions)
      // Use capture phase (true) as the event bubbles up from the details element itself
      document.addEventListener("toggle", (e) => {
        // Only save state if the toggled element is an accordion
        if (e.target && e.target.classList.contains("acc")) {
          saveOpenState();
        }
      }, true);

      // Run initial setup when the script loads
      restoreOpenState(); // Restore state from previous session
      updateCounts();     // Update counts based on initial state or restored state
    })();
  </script>
</body>
</html>
