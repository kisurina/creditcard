<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=13">
  <title>カード診断</title>
  <style>
    /* Accordion styles for filter sections */
    .acc { border: 1px solid #ddd; border-radius: 6px; margin: 10px 0; background: #fff; overflow: hidden; }
    .acc[open] { box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .acc-summary {
      list-style: none; /* Remove default marker */
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 15px; 
      background-color: #f8f9fa; 
      border-bottom: 1px solid #eee; 
    }
    .acc-summary::-webkit-details-marker { display: none; }
    .acc-summary::marker { display: none; }
    .acc-title { font-weight: 600; flex-grow: 1; color: #333; }
    .acc-meta { font-size: .9rem; color: #555; white-space: nowrap; }
    .chevron {
        transition: transform .2s ease;
        user-select: none; 
        font-size: 1.2em; 
        color: #777;
        width: 20px; 
        text-align: center;
    }
    .acc[open] > .acc-summary .chevron { transform: rotate(180deg); }
    .acc-content { padding: 10px 15px 15px; border-top: none; background-color: #fff; }

    .brand-desc {
      font-size: 0.85em; 
      color: #555; 
      margin-left: 22px; 
      display: block; 
      line-height: 1.4; 
      margin-top: 2px; 
    }
    
    .radio-block {
      display: block;
      margin-bottom: 8px;
      padding: 5px;
      cursor: pointer;
    }
    .radio-block input {
      margin-right: 8px;
    }
    .radio-block:hover {
      background-color: #f9f9f9;
    }
    
  </style>
</head>
<body>
  <div class="container">
    <h1>クレジットカード診断</h1>
    {% if results_html %}
      <div id="results">
        {{ results_html|safe }}
      </div>
      <form action="/" method="get" class="back-button" style="text-align: center; margin-top: 25px;">
        <button type="submit">診断条件を再入力する</button>
      </form>
    {% else %}
      <p>あなたにぴったりのクレジットカードを見つけましょう！</p>
      <form action="/diagnose" method="post">

        <label for="amount">月の利用金額（円）</label>
        <input type="number" id="amount" name="amount" min="0" placeholder="（任意）例: 50000">

        <label for="keyword">キーワード検索（カード名・発行会社）</label>
        <input type="text" id="keyword" name="keyword" placeholder="（任意）例: 楽天">

        <label for="lifestyle_keywords">【ライフスタイル診断】よく利用するお店（キーワード）</label>
        <input type="text" id="lifestyle_keywords" name="lifestyle_keywords" placeholder="（任意）例: Amazon コンビニ イオン">
        {% for key, group in groups.items() %}
          <details class="acc" data-key="{{ key }}">
            <summary class="acc-summary">
              <span class="acc-title">{{ group["title"] }}</span>
              <span class="acc-meta"><span class="sel-count" aria-live="polite">0</span> 件選択</span>
              <span class="chevron" aria-hidden="true">▼</span>
            </summary>
            
            <div class="acc-content">
              {% for item in group["items"] %}
                
                {% if key == "brands" %}
                  <label class="checkbox-block">
                    <input type="checkbox" name="{{ key }}" value="{{ item.name }}">
                    <span>{{ item.name }}</span>
                    <small class="brand-desc">{{ item.desc }}</small>
                  </label>

                {% elif key == "lifestyle_single" %}
                  <label class="radio-block">
                    <input type="radio" name="{{ key }}" value="{{ item }}">
                    <span>{{ item }}</span>
                  </label>
                  
                {% else %}
                  <label class="checkbox-block">
                    <input type="checkbox" name="{{ key }}" value="{{ item }}">
                    <span>{{ item }}</span>
                  </label>
                {% endif %}
                
              {% endfor %}
            </div>
            
          </details>
        {% endfor %}

        <button type="submit">診断する</button>
      </form>
    {% endif %}
  </div>

  <script>
    (function () {
      const ACC_STATE_KEY = "cc_filter_acc_open"; // Key for localStorage

      function updateCounts() {
        document.querySelectorAll(".acc").forEach(acc => {
          const key = acc.getAttribute("data-key");
          const countEl = acc.querySelector(".sel-count");
          if (key && countEl) {
            let checkedCount = 0;
            if (key === 'lifestyle_single') {
              checkedCount = acc.querySelectorAll(`input[name="${key}"]:checked`).length;
            } else {
              checkedCount = acc.querySelectorAll(`input[name="${key}"]:checked`).length;
            }
            countEl.textContent = String(checkedCount); 
          }
        });
      }

      function restoreOpenState() {
        try {
          const rawState = localStorage.getItem(ACC_STATE_KEY);
          if (!rawState) return; 
          const state = JSON.parse(rawState);
          if (typeof state !== 'object' || state === null) return;

          document.querySelectorAll(".acc").forEach(acc => {
            const key = acc.getAttribute("data-key");
            if (key && state.hasOwnProperty(key)) {
               if (state[key]) {
                   acc.setAttribute("open", ""); 
               } else {
                   acc.removeAttribute("open"); 
               }
            }
          });
        } catch (e) {
          console.error("Failed to restore accordion state:", e);
          localStorage.removeItem(ACC_STATE_KEY); 
        }
      }

      function saveOpenState() {
        const state = {};
        document.querySelectorAll(".acc").forEach(acc => {
          const key = acc.getAttribute("data-key");
          if (key) {
             state[key] = acc.hasAttribute("open");
          }
        });
        try {
            localStorage.setItem(ACC_STATE_KEY, JSON.stringify(state));
        } catch (e) {
            console.error("Failed to save accordion state:", e);
        }
      }

      document.addEventListener("change", (e) => {
        if (e.target && (e.target.matches('input[type="checkbox"]') || e.target.matches('input[type="radio"]'))) {
          updateCounts();
        }
      });

      document.addEventListener("toggle", (e) => {
        if (e.target && e.target.classList.contains("acc")) {
          saveOpenState();
        }
      }, true);

      restoreOpenState(); 
      updateCounts();     
    })();
  </script>
</body>
</html>